[gd_scene load_steps=11 format=1]

[ext_resource path="res://background2.png" type="Texture" id=1]
[ext_resource path="res://aPlayer.tscn" type="PackedScene" id=2]
[ext_resource path="res://player2.png" type="Texture" id=3]
[ext_resource path="res://player3.png" type="Texture" id=4]
[ext_resource path="res://white.png" type="Texture" id=5]

[sub_resource type="GDScript" id=1]

script/source = "extends Node2D


var balls = []
var scores = []
var speeds = []

export var scale_abberation = true
export var base_abberation = 0.005
export var default_distorted_abberation = 0.025

onready var shader = get_node(\"shader\").get_material()
onready var timer = get_node(\"Timer\")

var time = 0.0
var iteration = 0

export var scale_shaking = true
var shaking = false
export var shake_roughness = 1
export var shake_speed = 64
export var default_shake_magnitude = 8
var shake_magnitude = default_shake_magnitude


func _ready():
	# Init balls, scores and speeds arrays
	var count = 1
	while true:
		var ball = get_node(\"ball\" + str(count))
		
		if ball == null:
			break
		
		balls.append(ball)
		scores.append(0)
		speeds.append(0)
		
		count += 1
	
	# Connect balls
	for ball in balls:
		ball.connect(\"body_enter\", self, \"_on_collision\")
	
	# Connect timer
	timer.connect(\"timeout\", self, \"_on_timeout\")
	
	# Reset abberation
	reset_abberation()
	
	# Start process
	set_process(true)

func _process(delta):
	# Fetch scores and speeds
	var count = 1
	while count <= balls.size():
		var ball = balls[count - 1]
		var speed = ball.get_linear_velocity().length()
		
		scores[count - 1] += speed * delta
		speeds[count - 1] = speed
		
		count += 1
	
	# Shaking
	time += delta
	if time >= (2 * PI):
		time = 0
	
	if shaking:
		if iteration == shake_roughness:
			set_pos(Vector2(sin(time * shake_speed) * shake_magnitude, 0))
	
	# Iteration counting
	iteration += 1
	if iteration > shake_roughness:
		iteration = 0

func _on_collision(object):
	var magnitude = object.get_linear_velocity().length()
	distort_abberation(magnitude)
	start_shaking(magnitude)
	timer.start()

func _on_timeout():
	reset_abberation()
	reset_shaking()

func reset_abberation():
	\"\"\" Set abberation to its default value \"\"\"
	set_abberation(base_abberation)

func set_abberation(value):
	\"\"\" Set chromatic abberation magnitude \"\"\"
	shader.set_shader_param(\"rOffset\", Vector2(value, 0))
	shader.set_shader_param(\"bOffset\", Vector2(-value, 0))

func distort_abberation(magnitude):
	\"\"\" Offsets the abberation by default_distorted_abberation and sets timer to reset it \"\"\"
	if scale_abberation:
		# Add the collision magnitude to the distortion magnitude
		magnitude *= 0.0001
		set_abberation(default_distorted_abberation + magnitude)
	else:
		set_abberation(default_distorted_abberation)

func start_shaking(magnitude):
	\"\"\" Start shaking \"\"\"
	if scale_shaking:  # If we do not scale shaking, we leave the shake_magnitude as default
		# Add the collision magnitude to the shaking magnitude
		magnitude *= 0.05
		shake_magnitude = default_shake_magnitude + magnitude
	shaking = true

func reset_shaking():
	\"\"\" Sets position to (0, 0) and turns off shaking \"\"\"
	set_pos(Vector2(0, 0))
	shaking = false

func get_scores():
	\"\"\" Returns an array of scores \"\"\"
	return scores

func get_speeds():
	\"\"\" Returns an array of speeds \"\"\"
	return speeds
"

[sub_resource type="CanvasItemShader" id=2]

_code = {
"fragment": "/* Color changing shader */
uniform float modifier = 0.02;

float f = TIME + UV.x + UV.y;

color c1 = tex(TEXTURE, UV);
color c2 = color(sin(f), cos(f), -sin(f), sin(f/2));

COLOR = c1 + c2 * modifier;",
"fragment_ofs": 0,
"light": "",
"light_ofs": 0,
"vertex": "",
"vertex_ofs": 0
}

[sub_resource type="CanvasItemMaterial" id=3]

shader/shader = SubResource( 2 )
shader/shading_mode = 0
shader_param/modifier = 0.025

[sub_resource type="CanvasItemShader" id=4]

_code = {
"fragment": "/* Chromatic abberation shader; Doesn't support transparency */
uniform vec2 rOffset;
uniform vec2 gOffset;
uniform vec2 bOffset;

float red = texscreen(SCREEN_UV + rOffset).r;
float green = texscreen(SCREEN_UV + gOffset).g;
float blue = texscreen(SCREEN_UV + bOffset).b;

COLOR = color(red, green, blue, 1.0);",
"fragment_ofs": 0,
"light": "",
"light_ofs": 0,
"vertex": "",
"vertex_ofs": 0
}

[sub_resource type="CanvasItemMaterial" id=5]

shader/shader = SubResource( 4 )
shader/shading_mode = 0
shader_param/rOffset = Vector2( 0.005, 0 )
shader_param/gOffset = Vector2( 0, 0 )
shader_param/bOffset = Vector2( -0.005, 0 )

[node name="canvas" type="Node2D"]

script/script = SubResource( 1 )
scale_abberation = true
base_abberation = 0.005
default_distorted_abberation = 0.025
scale_shaking = true
shake_roughness = 1
shake_speed = 64
default_shake_magnitude = 8

[node name="background" type="Sprite" parent="."]

material/material = SubResource( 3 )
transform/pos = Vector2( 720, 450 )
texture = ExtResource( 1 )

[node name="ball1" parent="." instance=ExtResource( 2 )]

transform/pos = Vector2( 360, 450 )

[node name="ball2" parent="." instance=ExtResource( 2 )]

transform/pos = Vector2( 720, 450 )
player = 2
texture = ExtResource( 3 )

[node name="ball3" parent="." instance=ExtResource( 2 )]

transform/pos = Vector2( 1080, 450 )
player = 3
texture = ExtResource( 4 )

[node name="shader" type="Sprite" parent="."]

material/material = SubResource( 5 )
transform/pos = Vector2( 720, 450 )
transform/scale = Vector2( 27, 18 )
texture = ExtResource( 5 )

[node name="Timer" type="Timer" parent="."]

process_mode = 1
wait_time = 0.15
one_shot = true
autostart = false


